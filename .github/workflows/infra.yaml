name: Infrastructure Manager

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform Action'
        required: true
        default: 'apply'
        type: choice
        options:
        - apply
        - destroy

permissions:
  id-token: write
  contents: read

jobs:
  manage-infra:
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      RESOURCE_GROUP: "devops-portfolio-rg"
      CLUSTER_NAME: "devops-portfolio-aks"
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      # 1. BUILD OR DESTROY INFRASTRUCTURE
      - name: Terraform Run
        working-directory: ./terraform
        run: |
          terraform init
          terraform ${{ github.event.inputs.action }} -auto-approve

# 2. GET ACCESS INFO & URLS
      # (We removed the manual Helm install because Terraform addons.tf handles it now)
      - name: üìä Get Access Info
        if: ${{ github.event.inputs.action == 'apply' }}
        run: |
          # 1. Login to Azure to get kubeconfig
          az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
          az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME --overwrite-existing

          echo "‚è≥ Waiting for NGINX Ingress to receive Public IP from Azure..."

          # 2. Wait for NGINX Controller IP (The Single Entry Point)
          NGINX_IP=""
          while [ -z "$NGINX_IP" ]; do
            # We look for the ingress-nginx-controller service
            NGINX_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
            
            if [ -z "$NGINX_IP" ]; then
              echo "   (Waiting for Azure Public IP...)"
              sleep 10
            fi
          done

          echo "‚úÖ NGINX IP Found: $NGINX_IP"

          # 3. Get Argo CD Password
          echo "üîê Retrieving Argo CD Password..."
          ARGO_PWD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)

          # 4. Construct URLs
          # Update this variable if you changed the dns-label in addons.tf
          DNS_LABEL="tapan-gitops-app"
          REGION="eastus2" # Update this to your actual region (e.g. eastus)
          
          # The Full Azure DNS Name
          DNS_NAME="${DNS_LABEL}.${REGION}.cloudapp.azure.com"

          # --- PRINT OUTPUT ---
          echo "====================================================="
          echo "üöÄ DEPLOYMENT SUCCESSFUL!"
          echo "====================================================="
          echo ""
          echo "üåê PUBLIC ACCESS (DNS):"
          echo "   (Note: DNS propagation might take 1-2 mins)"
          echo "   üëâ App URL:      http://${DNS_NAME}/"
          echo "   üëâ Argo CD URL:  http://${DNS_NAME}/argocd/"
          echo ""
          echo "üîå DIRECT IP ACCESS (If DNS fails):"
          echo "   üëâ App IP:       http://${NGINX_IP}/"
          echo "   üëâ Argo CD IP:   http://${NGINX_IP}/argocd/"
          echo ""
          echo "üîë ARGO CD CREDENTIALS:"
          echo "   User:     admin"
          echo "   Password: $ARGO_PWD"
          echo ""
          echo "====================================================="