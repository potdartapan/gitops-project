name: Infrastructure Manager

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform Action'
        required: true
        default: 'apply'
        type: choice
        options:
        - apply
        - destroy

permissions:
  id-token: write
  contents: read

jobs:
  manage-infra:
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      RESOURCE_GROUP: "devops-portfolio-rg"
      CLUSTER_NAME: "devops-portfolio-aks"
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      # 1. BUILD OR DESTROY INFRASTRUCTURE
      - name: Terraform Run
        working-directory: ./terraform
        run: |
          terraform init
          terraform ${{ github.event.inputs.action }} -auto-approve

      # 2. INSTALL ARGO CD (Only runs if we just applied infrastructure)
      - name: Bootstrap Cluster
        if: ${{ github.event.inputs.action == 'apply' }}
        run: |
          # Login to Azure to get credentials for the NEW cluster
          az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
          az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME --overwrite-existing

          # Install Argo CD via Helm
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo update
          helm upgrade --install argocd argo/argo-cd \
            --namespace argocd \
            --create-namespace \
            --version 5.46.7 \
            --set server.service.type=LoadBalancer \
            --set server.insecure=true \
            --wait

          # Apply the "Master Manifests" to start the sync
          kubectl apply -f k8s/postgres.yaml
          kubectl apply -f k8s/argocd-app.yaml
# 3. OUTPUT DASHBOARD (Robust Version)
      - name: üìä Get Access Info
        if: ${{ github.event.inputs.action == 'apply' }}
        run: |
          # 1. Login again to ensure context
          az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
          az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME --overwrite-existing

          echo "‚è≥ Waiting for Argo CD to sync and services to appear..."

          # --- WAIT FOR TODO APP SERVICE ---
          # Loop until the Service actually exists (Argo CD has synced)
          echo "   -> Looking for Todo App Service..."
          while [ $(kubectl get svc -n default -l app=todo-app --no-headers 2>/dev/null | wc -l) -eq 0 ]; do
            echo "      (Service not found yet... waiting for Argo CD)"
            sleep 10
          done

          # Now Loop until Azure assigns the IP
          echo "   -> Service found! Waiting for Public IP..."
          TODO_IP=""
          while [ -z "$TODO_IP" ]; do
            TODO_IP=$(kubectl get svc -n default -l app=todo-app -o jsonpath='{.items[0].status.loadBalancer.ingress[0].ip}' 2>/dev/null)
            [ -z "$TODO_IP" ] && sleep 10
          done

          # --- WAIT FOR ARGO CD SERVICE ---
          echo "   -> Looking for Argo CD Server..."
          ARGO_IP=""
          while [ -z "$ARGO_IP" ]; do
            # Note: We use the specific service name 'argocd-server' here
            ARGO_IP=$(kubectl get svc -n argocd argocd-server -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
            [ -z "$ARGO_IP" ] && sleep 10
          done

          # --- GET PASSWORD ---
          ARGO_PWD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)

          # --- PRINT OUTPUT ---
          echo "====================================================="
          echo "üöÄ DEPLOYMENT SUCCESSFUL!"
          echo "====================================================="
          echo ""
          echo "üìù TODO APPLICATION:"
          echo "   URL: http://$TODO_IP"
          echo ""
          echo "üêô ARGO CD DASHBOARD:"
          echo "   URL:      https://$ARGO_IP"
          echo "   User:     admin"
          echo "   Password: $ARGO_PWD"
          echo ""
          echo "====================================================="
          echo "‚ö†Ô∏è  NOTE: It may take 1-2 minutes for the URLs to become reachable."