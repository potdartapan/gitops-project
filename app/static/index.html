<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>

    <header class="app-header">
        <div class="brand">
            <span>âš¡</span> DevOps TaskMaster
        </div>
        <div class="user-profile" style="font-size: 0.9rem; color: var(--text-secondary);">
            Admin User
        </div>
    </header>

    <main class="main-content">
        <div class="dashboard-card">
            <div class="card-header">
                <h2>My Tasks</h2>
            </div>

            <div class="input-section">
                <input type="text" id="todoInput" placeholder="What needs to be done?" onkeypress="handleKeyPress(event)">
                <button class="btn-primary" onclick="addTodo()">Add Task</button>
            </div>

            <ul id="todoList" class="todo-list">
                <!-- Items will be injected here -->
            </ul>

            <div id="emptyState" class="empty-state" style="display: none;">
                <p>No tasks yet. Add one above to get started!</p>
            </div>
        </div>
    </main>

    <script>
        const API_URL = '/todos';

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                addTodo();
            }
        }

        async function fetchTodos() {
            try {
                const response = await fetch(API_URL);
                const todos = await response.json();
                renderTodos(todos);
            } catch (error) {
                console.error('Error fetching todos:', error);
            }
        }

        function renderTodos(todos) {
            const list = document.getElementById('todoList');
            const emptyState = document.getElementById('emptyState');

            list.innerHTML = '';

            if (todos.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            todos.forEach(todo => {
                const li = document.createElement('li');
                li.className = 'todo-item';

                // Construct DOM elements safely to prevent XSS
                const contentDiv = document.createElement('div');
                contentDiv.className = 'todo-content';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = todo.completed;
                checkbox.onchange = () => toggleTodo(todo.id, checkbox.checked);

                const span = document.createElement('span');
                span.className = `todo-text ${todo.completed ? 'completed' : ''}`;
                span.textContent = todo.title;

                contentDiv.appendChild(checkbox);
                contentDiv.appendChild(span);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete';
                deleteBtn.title = 'Delete task';
                deleteBtn.onclick = () => deleteTodo(todo.id);
                deleteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                `;

                li.appendChild(contentDiv);
                li.appendChild(deleteBtn);
                list.appendChild(li);
            });
        }

        async function addTodo() {
            const input = document.getElementById('todoInput');
            const title = input.value.trim();
            if (!title) return;

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title })
                });
                input.value = '';
                fetchTodos();
            } catch (error) {
                console.error('Error adding todo:', error);
            }
        }

        async function toggleTodo(id, isChecked) {
            try {
                await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: isChecked })
                });
                fetchTodos();
            } catch (error) {
                console.error('Error toggling todo:', error);
            }
        }

        async function deleteTodo(id) {
            if(!confirm("Are you sure you want to delete this task?")) return;
            try {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                fetchTodos();
            } catch (error) {
                console.error('Error deleting todo:', error);
            }
        }

        // Initial Load
        fetchTodos();
    </script>
</body>
</html>
